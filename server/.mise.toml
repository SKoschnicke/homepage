[tasks.dev]
description = "Build and run server locally with self-signed cert"
run = """
#!/usr/bin/env bash
set -e

# Check if hugo server is running
if pgrep -f "hugo server" > /dev/null; then
  echo "Hugo development server is running. Stop it before deploying:
    pkill -f 'hugo server'

Running hugo server interferes with server builds."
  exit 1
fi

# Go to project root (one level up from server/)
cd "$MISE_PROJECT_ROOT/.."

# Clean public directory to ensure no dev artifacts
if [ -d "public" ]; then
  echo "Removing existing public/ directory"
  rm -rf public
fi

# Build fresh production site
echo "Building Hugo site with --minify"
if ! hugo --minify; then
  echo "Hugo build failed"
fi

cd "$MISE_PROJECT_ROOT"

echo "Building release binary..."
cargo build --release

echo "Setting capabilities..."
sudo setcap 'cap_net_bind_service=+ep' target/release/static-server

echo "Starting server..."
DOMAIN=localhost \
LOCAL_DEV=true \
ACME_CONTACT_EMAIL=s.koschnicke@gfxpro.com \
./target/release/static-server
"""

[tasks.build]
description = "Build release binary and set capabilities"
run = """
#!/usr/bin/env bash
set -e

cargo build --release
sudo setcap 'cap_net_bind_service=+ep' target/release/static-server
echo "âœ“ Binary built and capabilities set"
"""
